**聊天软件背后是什么**

相信我们都用过QQ、微信和好朋友聊天吧，在聊天的过程中我们发送了一条消息，可以是文本、图片或是语音，而对方很快就收到了这条消息并用同样的方式回复了你，随后你们交谈甚欢，有一种天涯若比邻的感觉。

其实这就是聊天软件的背后，消息系统的应用之一：「**IM**」（Instant Messaging，即时通信），可以说现在主流的软件中，IM无处不在，覆盖了社交软件、电商软件、游戏、办公等诸多场景。

本文章作为第一篇软文，主要讲述即时通信（IM）系统的基本架构演进过程，以便读者能够快速建立关于现代IM系统的印象。

***\*传统的IM系统\****

如果要讲现代的IM系统，就不得不提起曾经的IM系统了。此处我们可以用PC时代的QQ打比方，还记得那时我们发送一条消息的过程吗？

1、你登陆QQ，随后找自己的老铁发一句：「**在吗****？**」，而此时碰巧他刚好在线，他的电脑上的**小🐧**会开始闪烁，证明他收到了你的消息。

2、他如果不在线，那么你的消息便不能立即推送给他了，他也感知不到你正在找他聊天呢。

3、只有等到他登陆的时候才能收到你的消息，并且他登陆的瞬间也可能收到很多其他人/群的消息。

![img](https://mmbiz.qpic.cn/sz_mmbiz_jpg/jeud9IwMmEGNKkEsbQXsXxzb8LtR8RYHrqn6JwXxTeHFRianVXW5ZYPvyt2TLHibDaibzVtds82jUrYZHjelwYYTQ/640?wx_fmt=jpeg&from=appmsg)

正如上图所表示的「**一个最简单的IM模型**」，如果双方都在线的话，消息会在线地推送给他。而如果他不在线，系统找不到目标将无法推送，所以此时的推送为虚线。

所以即使是最简单的IM模型，也需要「**维护用户的在线状态**」。

为了让你发送的消息能够在对方登录时收到，IM系统会正常接受推送并进行存储，而等到他登陆以后，他的客户端会主动拉取离线时接受的消息，拉取消息后服务端会删除这些数据，这便是初级IM系统对于消息处理的大致过程。你也许会好奇几个问题：

**1、为什么对方在线时消息不存储？**

早期的IM系统只是用于聊天通信，出于存储和维护的成本考虑，如果对方成功接收到了你的消息，再额外存一份也没什么必要了。

**2、为什么离线消息被拉取后会删除？**

同样出于成本考虑，而且假设所有的离线消息都持久化，下一次对消息的拉取（查询）便会有非常大的开销，会出现登陆后刷不出消息的问题。

这就会导致，用户换了个电脑之后，曾经的聊天记录全找不到了，想要查询漫游消息还需要「**充个Vip**」。

其实这也比较好理解，在互联网发展早期，数据库技术的发展远没有今天这么繁荣，而且那时国内还没有去IOE，数据的存储成本是非常之高的。

随着互联网的普及，即时通信很快变成了人人都会使用的聊天交友工具，我记得那时候很多人去网吧「**仅仅是为了和网友聊天**」，可见那时候大家对IM的追捧是多么狂热。

在用户量激增和业务快速发展的过程中，传统的IM系统已经无法满足需求了，因此现代IM系统模型逐步形成。

**现代IM系统的雏形**

为了保证多端设备的消息能够一致，新设备登陆时需要从服务端查询历史消息，那就势必要将所有消息都存储下来。

因此存储消息便成了发送消息的第一步，而第二步是对用户在线的设备进行推送，下图中B用户存在3个设备（B1、B2、B3），其中B1、B2在线，那么此时会将消息推送至这两个设备上。

而对于离线的B3，其实和C用户的离线设备一样，都无法直接推送，取而代之的是在他们登陆时主动进行消息的拉取。

![img](https://mmbiz.qpic.cn/sz_mmbiz_jpg/jeud9IwMmEGNKkEsbQXsXxzb8LtR8RYHF5rz65BfVzgkoeUIlGnZJsJhfN6OtfQM3dO54JY8rsDiaw9WgFby3sQ/640?wx_fmt=jpeg&from=appmsg)

存储成本的降低和审计监管的需要，无论是在线消息还是离线消息都被IM系统存储下来，这也意味着充Vip才能查看历史消息的日子一去不复返了。

以至于无论我们去哪里上网，只要输入密码登陆成功，便可以获取到以往所有的聊天记录，因此有一段时间，人们也会「**用IM软件作为联网的备忘录**」。

而这种架构模型面临的核心问题就是，因为所有消息都要持久化存储，而在很多离线用户登陆后还需要从这个库中拉取消息，这就导致该消息库的存储和查询的「**负载特别高**」。

解决该问题的典型方案有几种：

1.定期清除一些数据以减轻负担，但这会导致历史消息丢失。

2.对数据库进行水平扩展——从单体机房升级为分布式集群。

3.冷热数据的分离，将历史数据永久存储，而将近期的热数据则单独存储。

显然，后两种方案在实践中是更为可行的，随后整个IM系统的架构也走向了成熟，形成了现代的IM系统

**现代的IM系统**

实际上一个现代IM系统中还有各种特定的机制，例如使用Message Queue进行解耦、使用信令完成轻功能的实现，以及群聊、智能聊天等功能。

但是为了便于读者快速理解系统基本原理，本阶段主要描述发送方、接收方以及他们之间收发消息（存储和同步）机制——整个系统最核心的部分，如下图所示。

![img](https://mmbiz.qpic.cn/sz_mmbiz_jpg/jeud9IwMmEGNKkEsbQXsXxzb8LtR8RYHBXEHwA6ZuWiafwkh4ic73H4icUic9qSaFc0V0FXiaJBvJXalB0huvEzDHpQ/640?wx_fmt=jpeg)

通过IM系统发送消息的第一步依然是存储操作，将信息持久化到DB中，注意此时的DB已经不再是曾经的单体架构，而是一个分布式的数据库集群（随着数据库技术的发展，即使是Mysql也可以借助中间件，如阿里云的RDS完成分布式集群的搭建），

此时的DB在IM领域内被称作「**消息漫游库**」。

第二步是将消息同步到另外的一个存储当中，虽然图中用Cache来表示，但和传统的缓存又稍微区别（可以看作一种特殊的缓存），

详细情况会在文章最后展开介绍，这个存储被称为「**消息同步库**」。

将消息存储到上述的两个库之后，我们便开始了系统的后半程，那就是让用户获取到消息。此时的B1、B2都在线，因此可以直接推送到设备上，用户B即可获取到了消息。

注意，此时我们将B3和C稍微做一下区分。

这里假设B3很快就登陆了，那么它会从消息同步库中拉取最新的消息。而C在收到消息后的很长一段时间都没有登陆，它再登陆的时候便会从消息漫游库中拉取最近未读的全量消息。

这样做的目的只有一个：消息同步库本质上是个缓存，存储成本很高，因此一定要珍惜空间——只存储最近的热消息。



**消息同步库**

上文提到了消息同步库（「**一个特殊的缓存**」），它用于完成未读消息的快速接受以及多端同步。因此需要具有如下特性：

1.可以为每个接受者开辟一个收件箱，按顺序存放即时消息。

2.可以根据消息的SequenceId，顺序拉取最新（未读）的消息。

3.支持分布式，且具有极强的响应速度。

根据这几种特性，我们便能够设计出如下的同步库模型：

首先，消息按照各的SequcenId排序，这个Id可以不保证连续，但是一定要严格递增。

消息接收方可以根据指定的SequenceId定位到指定的点位，如图中竖线所在的位置，紧接着便可以同步拉取到该点位右侧的最新消息了。

![img](https://mmbiz.qpic.cn/sz_mmbiz_png/jeud9IwMmEGibBkHM1XJROxCqw9SnlsyoHTicY1lAxUKibe1zbbqMTwykcMCZ0ktegzOmZuMdXR2Sac9gGsUt3b4A/640?wx_fmt=png&from=appmsg)

乍一看人们会认为消息同步库是一个消息队列，上面的图也像一个「消息队列，但其实并非如此」。正如我们之前所说的，我们需要给每一个用户开辟一个收件箱，且需要有极强的响应速度，在用户上线时同步到消息，这与消息队列的异步设计理念完全不同。

更适用于上述需求的中间件应该是缓存（Redis），可以将receiverId作为Key，即时消息List作为Value进行存储，从而完成对未读消息（热数据）的快速同步。

为了满足「**多端同步的需要**」，该收件箱中的数据并不会在做完了某次同步后就立即删除，因为用户的其他设备仍存在同步最新消息的需要。

并且用户可能短时间存在着大量的未读消息需要接收，而缓存的存储成本又比较高，那么同步库该如何设计才能避免「**缓存膨胀**」呢？

下面的图示提供了一种同步库设计思路——采用「**环形队列**」的数据结构。

![img](https://mmbiz.qpic.cn/sz_mmbiz_png/jeud9IwMmEGibBkHM1XJROxCqw9SnlsyoVnkV6gnDicoVP6B1JUHic34G3l55SNuIJs212e8ta7m7v5ZllGlkScEQ/640?wx_fmt=png&from=appmsg)

环形的队列最显著的特点是有着特定的容量上限，当最近的消息超过了该上限时会循环写——**覆盖掉队列中最旧的元素**。

整个同步流程其实和上面的线性队列类似，接收方可以根据特定的SequenceId定位到特定的点位，随后拉取最新的未读消息。

此处需要注意的是，缓存容量存在上限，就意味着有可能有未读消息被循环写覆盖掉了，那么此时就需要从消息漫游库DB中「**拉取消息作为补偿了**」。

但实际上这种情况出现的机会并不多，因此无需太过担心DB的负载。

建议在业务早期设置一个较小的容量，随着发展可以逐步上调该容量。

**结语**

综上，便是现代IM系统的基本架构，其中「**最核心的就是两个消息库**」：

1、消息漫游库，用于全量保存所有会话的消息，支持消息漫游。

2、消息同步库，主要用于接收方的快速接受，以及多端同步。



正是依赖它们，海量消息的存储和同步问题才得以迎刃而解。

而先存储后同步的好处是，如果接收方确认接收到了消息，那这条消息一定是已经在云端保存了。

M系统在互联网初期即存在，其基础技术架构在这十几年的发展中更新迭代多次。

从早期的CS、P2P架构，到现在已经演变为一个「**复杂的分布式系统**」，涉及移动端、网络通信、协议、安全、存储和搜索等技术的方方面面。


